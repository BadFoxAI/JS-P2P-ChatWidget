
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Chat - V5 Enhanced</title>
    <style>
        /* --- Theme Variables --- */
        :root { /* Default: Dark Theme */
            --chat-bg-body: #1a1a1a; --chat-bg-container: #2d2d2d; --chat-bg-input: #3c3c3c;
            --chat-bg-chat: #252525; --chat-bg-status-area: #333333; --chat-bg-button-primary: #007acc;
            --chat-bg-button-primary-hover: #005fa3; --chat-bg-button-secondary: #505050;
            --chat-bg-button-secondary-hover: #606060; --chat-bg-button-disabled: #404040;
            --chat-text-primary: #e0e0e0; --chat-text-secondary: #b0b0b0; --chat-text-input: #f0f0f0;
            --chat-text-button: #ffffff; --chat-text-button-secondary: #e0e0e0; --chat-text-system: #9e9e9e;
            --chat-border-color: #4a4a4a; --chat-msg-bg-local: #004d7a; --chat-msg-bg-remote: #3e4042;
            --chat-icon-color: #b0b0b0; --chat-icon-hover-color: #ffffff; --chat-box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            --chat-modal-bg: rgba(0, 0, 0, 0.6); --chat-modal-content-bg: var(--chat-bg-container);
            --chat-section-bg: #292929;
        }
        body.chat-light-theme { /* Light Theme Overrides */
            --chat-bg-body: #f4f6f8; --chat-bg-container: #ffffff; --chat-bg-input: #f0f0f0;
            --chat-bg-chat: #f5f5f5; --chat-bg-status-area: #e9ecef; --chat-bg-button-primary: #007bff;
            --chat-bg-button-primary-hover: #0056b3; --chat-bg-button-secondary: #6c757d;
            --chat-bg-button-secondary-hover: #545b62; --chat-bg-button-disabled: #cccccc;
            --chat-text-primary: #212529; --chat-text-secondary: #495057; --chat-text-input: #333333;
            --chat-text-button: #ffffff; --chat-text-button-secondary: #ffffff; --chat-text-system: #6c757d;
            --chat-border-color: #ced4da; --chat-msg-bg-local: #007bff; --chat-msg-bg-remote: #e9ecef;
            --chat-icon-color: #495057; --chat-icon-hover-color: #000000; --chat-box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            --chat-modal-bg: rgba(0, 0, 0, 0.4); --chat-modal-content-bg: var(--chat-bg-container);
            --chat-section-bg: #f8f9fa;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--chat-bg-body); color: var(--chat-text-primary); margin: 0; padding: 0; font-size: 15px; line-height: 1.6; transition: background-color 0.2s ease-out, color 0.2s ease-out; }
        #chatModuleWrapper { position: fixed; bottom: 20px; right: 20px; z-index: 1000; transition: all 0.3s ease-in-out; } /* Added transition */
        #chatModuleContainer { width: 380px; max-height: calc(100vh - 40px); display: flex; flex-direction: column; background-color: var(--chat-bg-container); color: var(--chat-text-primary); border-radius: 10px; box-shadow: var(--chat-box-shadow); border: 1px solid var(--chat-border-color); overflow: hidden; transition: width 0.25s ease-out, height 0.25s ease-out, opacity 0.25s ease-out, transform 0.25s ease-out; transform-origin: bottom right; }
        #chatModuleContainer.collapsed { width: 48px; height: 48px; padding: 0; overflow: visible; border: none; background-color: transparent; box-shadow: none; }
        #chatModuleContainer.collapsed > *:not(#moduleToggleBar) { display: none !important; }
        #moduleToggleBar { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background-color: var(--chat-bg-status-area); border-bottom: 1px solid var(--chat-border-color); user-select: none; cursor: default; flex-shrink: 0; } /* Added shrink */
        #chatModuleContainer.collapsed #moduleToggleBar { padding: 0; background-color: var(--chat-bg-button-secondary); width: 48px; height: 48px; border-radius: 50%; justify-content: center; align-items: center; border-bottom: none; box-shadow: var(--chat-box-shadow); cursor: pointer; }
        #chatModuleContainer.collapsed #moduleToggleBar #chatModuleTitle,
        #chatModuleContainer.collapsed #moduleToggleBar #fullFrameToggleIcon,
        #chatModuleContainer.collapsed #moduleToggleBar #themeToggleIcon,
        #chatModuleContainer.collapsed #moduleToggleBar #clearStorageIcon { display: none !important; }
        #chatModuleContainer.collapsed #moduleToggleBar #collapseIcon { display: inline-flex !important; align-items: center; justify-content: center; width: 100%; height: 100%; margin: 0; padding: 0; font-size: 22px; line-height: 1; border-radius: 0; }
        #chatModuleTitle { font-weight: 500; font-size: 1.05em; }
        .toggle-icon-group { display: flex; align-items: center; }
        #chatModuleContainer.collapsed #moduleToggleBar .toggle-icon-group { width: 100%; height: 100%; justify-content: center; }
        .toggle-icon { cursor: pointer; font-size: 20px; padding: 5px; margin-left: 6px; line-height: 1; color: var(--chat-icon-color); transition: color 0.2s ease, transform 0.15s ease; display: inline-flex; align-items: center; justify-content: center; border-radius: 4px; }
        .toggle-icon:hover { color: var(--chat-icon-hover-color); background-color: rgba(120,120,120,0.15);}
        .toggle-icon:active { transform: scale(0.9); }
        #chatModuleContent { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 300px; }
        #statusArea { margin-bottom: 10px; padding: 8px; background-color: var(--chat-bg-status-area); border-radius: 6px; flex-shrink: 0; }
        #status { color: var(--chat-text-secondary); font-style: italic; text-align: center; font-size: 0.9em; width: 100%; margin-bottom: 4px; word-wrap: break-word; }
        #peerIdDisplayArea { text-align: center; font-size: 0.85em; color: var(--chat-text-secondary); margin-top: 5px;}
        #myPeerIdValue { font-weight: bold; color: var(--chat-text-primary); user-select: all; }
        #copyMyIdBtn { padding: 4px 8px; font-size: 0.8em; margin-left: 8px; background-color: var(--chat-bg-button-secondary); color: var(--chat-text-button-secondary); border: none; border-radius: 4px; cursor: pointer; }
        #copyMyIdBtn:hover { background-color: var(--chat-bg-button-secondary-hover); }
        /* Combined and Collapsible Setup Section */
        .control-section#setupSection { background-color: var(--chat-section-bg); padding: 0; border-radius: 6px; margin-bottom: 10px; border: 1px solid var(--chat-border-color); flex-shrink: 0; transition: margin-bottom 0.3s ease-in-out; }
        .control-section#setupSection .section-title { font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; color: var(--chat-text-secondary); margin:0; padding: 8px 10px; border-bottom: 1px solid var(--chat-border-color); background-color: var(--chat-bg-status-area); border-top-left-radius: 6px; border-top-right-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;}
        .control-section#setupSection .section-title span { font-size: 0.8em; transition: transform 0.2s ease-in-out; }
        .control-section#setupSection.collapsed .section-title span { transform: rotate(-90deg); }
        .control-section#setupSection .section-content { padding: 10px; max-height: 500px; overflow: hidden; transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out, border 0.3s ease-in-out; border-top: 1px solid transparent; } /* Smooth transition */
        .control-section#setupSection.collapsed .section-content { max-height: 0; padding-top: 0; padding-bottom: 0; border-top: 1px solid var(--chat-border-color); margin-top:-1px;}
        .control-section#setupSection.collapsed { margin-bottom: 0; /* Reduce margin when collapsed */}

        .name-control-group { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
        #displayNameInput { flex-grow: 1; padding: 8px 10px; background-color: var(--chat-bg-input); color: var(--chat-text-input); border: 1px solid var(--chat-border-color); border-radius: 6px; font-size: 14px; }
        #displayNameInput::placeholder { color: var(--chat-text-secondary); opacity: 0.7;}
        #setDisplayNameBtn { padding: 8px 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: background-color 0.2s ease; background-color: var(--chat-bg-button-secondary); color: var(--chat-text-button-secondary); flex-shrink: 0; } /* Prevent button shrinking */
        #setDisplayNameBtn:hover { background-color: var(--chat-bg-button-secondary-hover); }
        .connection-buttons-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .connection-buttons-row button { flex-grow: 1; width: 50%; padding: 8px 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background-color 0.2s ease; background-color: var(--chat-bg-button-secondary); color: var(--chat-text-button-secondary); }
        .connection-buttons-row button:hover { background-color: var(--chat-bg-button-secondary-hover); }
        #connectSectionInput input[type="text"]#hostIdInput { width: 100%; box-sizing: border-box; padding: 8px 10px; background-color: var(--chat-bg-input); color: var(--chat-text-input); border: 1px solid var(--chat-border-color); border-radius: 6px; font-size: 14px;}
        #connectSectionInput input[type="text"]::placeholder { color: var(--chat-text-secondary); opacity: 0.7;}
        #sendBtn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: background-color 0.2s ease, color 0.2s ease; background-color: var(--chat-bg-button-primary); color: var(--chat-text-button); flex-shrink: 0; } /* Prevent shrinking */
        #sendBtn:hover { background-color: var(--chat-bg-button-primary-hover); }
        #hostBtn:disabled, #connectBtn:disabled, #sendBtn:disabled, #setDisplayNameBtn:disabled, #copyMyIdBtn:disabled { background-color: var(--chat-bg-button-disabled) !important; color: #888 !important; cursor: not-allowed; opacity: 0.7; } /* Added opacity */
        #chat { background-color: var(--chat-bg-chat); border: 1px solid var(--chat-border-color); overflow-y: auto; margin-bottom: 10px; padding: 10px; border-radius: 6px; flex-grow: 1; flex-shrink: 1; min-height: 80px; }
        .message-item { margin-bottom: 8px; padding: 8px 12px; border-radius: 15px; max-width: 85%; word-wrap: break-word; line-height: 1.4; } /* Adjusted line-height */
        .message-item.local { background-color: var(--chat-msg-bg-local); color: #e1f5fe; margin-left: auto; border-bottom-right-radius: 5px; text-align: left; } body.chat-light-theme .message-item.local { color: var(--chat-text-button); }
        .message-item.remote { background-color: var(--chat-msg-bg-remote); color: var(--chat-text-primary); margin-right: auto; border-bottom-left-radius: 5px; } body.chat-light-theme .message-item.remote { color: var(--chat-text-input); }
        .message-item .sender-tag { font-weight: 600; margin-right: 5px; display: inline-block; font-size: 0.9em; }
        .message-item .sender-tag.host { color: #c59eff; } body.chat-light-theme .message-item .sender-tag.host { color: #8a2be2;}
        .message-item .sender-tag.you { color: #90caf9; } body.chat-light-theme .message-item .sender-tag.you { color: var(--chat-bg-button-primary);}
        .message-item .sender-tag.peer { color: #aaaaaa; } body.chat-light-theme .message-item .sender-tag.peer { color: #555555;}
        .message-item.system-msg { background-color: transparent; color: var(--chat-text-system); font-style: italic; font-size: 0.85em; text-align: center; max-width: 100%; padding: 4px 0; }
        #messageInputArea { display: flex; margin-top: auto; flex-shrink: 0; padding-top: 5px; /* Add slight space above */ }
        #messageInput { flex-grow: 1; /* Take remaining space */ background-color: var(--chat-bg-input); color: var(--chat-text-input); border: 1px solid var(--chat-border-color); border-radius: 6px; font-size: 14px; margin-right: 8px; padding: 8px 10px; }
        #messageInput::placeholder { color: var(--chat-text-secondary); opacity: 0.7;}
        .modal-overlay { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: var(--chat-modal-bg); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--chat-modal-content-bg); margin: auto; padding: 20px; border: 1px solid var(--chat-border-color); border-radius: 8px; width: 80%; max-width: 320px; box-shadow: var(--chat-box-shadow); text-align: center; color: var(--chat-text-primary); }
        .modal-content p { margin-bottom: 20px; font-size: 1.05em; }
        .modal-buttons button { padding: 10px 18px; margin: 0 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: background-color 0.2s ease; }
        .modal-buttons button#confirmClearBtn { background-color: var(--chat-bg-button-primary); color: var(--chat-text-button); } .modal-buttons button#confirmClearBtn:hover { background-color: var(--chat-bg-button-primary-hover); }
        .modal-buttons button#cancelClearBtn { background-color: var(--chat-bg-button-secondary); color: var(--chat-text-button-secondary); } .modal-buttons button#cancelClearBtn:hover { background-color: var(--chat-bg-button-secondary-hover); }
        #chatModuleWrapper.full-frame-mode { width: 100%; height: 100%; bottom: 0; right: 0; top: 0; left: 0; padding:0; }
        #chatModuleWrapper.full-frame-mode #chatModuleContainer { width: 100%; height: 100%; max-height: 100vh; border-radius: 0; border: none; }
        #chatModuleWrapper.full-frame-mode #chatModuleContainer.collapsed > *:not(#moduleToggleBar) { display: flex !important; }
        #chatModuleWrapper.full-frame-mode #collapseIcon { display: none !important; }
    </style>
</head>
<body>
    <div id="chatModuleWrapper">
        <div id="chatModuleContainer">
            <div id="moduleToggleBar">
                <span id="chatModuleTitle">P2P Chat</span>
                <div class="toggle-icon-group">
                    <span id="fullFrameToggleIcon" class="toggle-icon" title="Toggle Full Frame">↗️</span>
                    <span id="clearStorageIcon" class="toggle-icon" title="Clear Stored Data">🗑️</span>
                    <span id="themeToggleIcon" class="toggle-icon" title="Toggle Theme">☀️</span>
                    <span id="collapseIcon" class="toggle-icon" title="Toggle Chat">✖️</span>
                </div>
            </div>
            <div id="chatModuleContent">
                <div id="statusArea">
                    <div id="status" class="status">Initializing...</div>
                </div>

                <div id="setupSection" class="control-section collapsible">
                    <p class="section-title" id="setupSectionTitle">Setup & Connection <span>🔽</span></p>
                    <div class="section-content">
                        <div id="peerIdDisplayArea" style="display: none; margin-bottom: 10px;">
                            Your ID: <span id="myPeerIdValue"></span>
                            <button id="copyMyIdBtn" disabled>Copy</button>
                        </div>
                        <div class="name-control-group">
                            <input type="text" id="displayNameInput" placeholder="Your Name (max 30 chars)">
                            <button id="setDisplayNameBtn">Set Name</button>
                        </div>
                        <hr style="border-color: var(--chat-border-color); border-style: dashed; margin: 12px 0;">
                        <div class="connection-buttons-row">
                            <button id="hostBtn">Become Host</button>
                            <button id="connectBtn">Connect to Peer</button>
                        </div>
                        <div id="connectSectionInput">
                            <input type="text" id="hostIdInput" placeholder="Peer ID (leave blank for ServerOne)">
                        </div>
                    </div>
                </div>

                <div id="chat"></div>

                <div id="messageInputArea">
                    <input type="text" id="messageInput" placeholder="Type message...">
                    <button id="sendBtn" disabled>Send</button>
                </div>
            </div>
        </div>
    </div>

    <div id="clearStorageModal" class="modal-overlay">
         <div class="modal-content">
            <p>Are you sure you want to clear all stored chat data?</p>
            <div class="modal-buttons">
                <button id="confirmClearBtn">Yes, Clear</button>
                <button id="cancelClearBtn">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script> <!-- Updated PeerJS version -->
    <script>
        "use strict";

        // --- Constants ---
        const MAX_PEER_INIT_ATTEMPTS = 5; const DEFAULT_PEER_ID_PREFIX = 'p2pwebchat-';
        const SHORT_ID_LENGTH = 7; const DISPLAY_NAME_MAX_LENGTH = 30;
        const LOCAL_STORAGE_KEYS = { THEME: 'p2pWebChatTheme_v4.1', DISPLAY_NAME: 'p2pWebChatDisplayName_v4.1', PEER_ID: 'p2pWebChatPeerId_v4.1', IS_FULL_FRAME: 'p2pWebChatIsFullFrame_v4.1', IS_SETUP_COLLAPSED: 'p2pWebChatIsSetupCollapsed_v4.1' };
        const SERVER_ONE_PEER_ID = 'p2p-webchat-serverone-20240101-E'; // Use a unique ID
        const MAX_CONSECUTIVE_SERVER_ERRORS = 3;

        // --- State ---
        let peer; let hostConnection; let connections = {}; let isHost = false; let messageQueue = [];
        let myPeerId = null; let myDisplayName = null; let peerInitAttempts = 0; let isChatModuleCollapsed = false;
        let currentTheme = localStorage.getItem(LOCAL_STORAGE_KEYS.THEME) || 'dark';
        let isFullFrame = localStorage.getItem(LOCAL_STORAGE_KEYS.IS_FULL_FRAME) === 'true';
        let isSetupSectionCollapsed = localStorage.getItem(LOCAL_STORAGE_KEYS.IS_SETUP_COLLAPSED) === 'true';
        let isActingAsServerOne = false; let currentConnectionTargetIsServerOne = false;
        let peerJsServerErrorCount = 0;

        // --- DOM Refs ---
        // (Assume all getElementById calls are here and correct as per previous examples)
        const chatModuleWrapper = document.getElementById('chatModuleWrapper'); const chatModuleContainerEl = document.getElementById('chatModuleContainer');
        const collapseIconEl = document.getElementById('collapseIcon'); const themeToggleIconEl = document.getElementById('themeToggleIcon');
        const clearStorageIconEl = document.getElementById('clearStorageIcon'); const fullFrameToggleIconEl = document.getElementById('fullFrameToggleIcon');
        const statusEl = document.getElementById('status'); const setupSectionEl = document.getElementById('setupSection');
        const setupSectionTitleEl = document.getElementById('setupSectionTitle'); const peerIdDisplayAreaEl = document.getElementById('peerIdDisplayArea');
        const myPeerIdValueEl = document.getElementById('myPeerIdValue'); const copyMyIdBtnEl = document.getElementById('copyMyIdBtn');
        const chatEl = document.getElementById('chat'); const messageInputAreaEl = document.getElementById('messageInputArea');
        const messageInputEl = document.getElementById('messageInput'); const sendBtnEl = document.getElementById('sendBtn');
        const hostBtnEl = document.getElementById('hostBtn'); const connectBtnEl = document.getElementById('connectBtn');
        const hostIdInputEl = document.getElementById('hostIdInput'); const displayNameInputEl = document.getElementById('displayNameInput');
        const setDisplayNameBtnEl = document.getElementById('setDisplayNameBtn'); const clearStorageModalEl = document.getElementById('clearStorageModal');
        const confirmClearBtnEl = document.getElementById('confirmClearBtn'); const cancelClearBtnEl = document.getElementById('cancelClearBtn');

        const textEncoder = new TextEncoder(); const textDecoder = new TextDecoder();

        // --- UTILS ---
        function sanitizeHTML(str){if(typeof str !== 'string')return ''; const t=document.createElement('div'); t.textContent=str; return t.innerHTML;}
        function getShortPeerId(id){if(!id)return '???'; if(id===SERVER_ONE_PEER_ID)return '🌟ServerOne'; return id.slice(-SHORT_ID_LENGTH);}
        function updateStatusUI(text){if(statusEl)statusEl.innerHTML=sanitizeHTML(text);}
        function logInfo(msg, ...args){console.info(`[P2P INFO] ${msg}`, ...args);}
        function logWarn(msg, ...args){console.warn(`[P2P WARN] ${msg}`, ...args);}
        function logError(msg, ...args){console.error(`[P2P ERROR] ${msg}`, ...args);}

        // --- CORE UI ---
        function applyTheme(theme){/* ... as before ... */ if(!document.body||!themeToggleIconEl)return; logInfo('Applying theme:', theme); document.body.classList.remove('chat-light-theme','chat-dark-theme'); document.body.classList.add(theme==='light'?'chat-light-theme':'chat-dark-theme'); themeToggleIconEl.innerHTML=theme==='light'?'🌙':'☀️'; themeToggleIconEl.title=`To ${theme==='light'?'Dark':'Light'}`; currentTheme=theme; localStorage.setItem(LOCAL_STORAGE_KEYS.THEME,theme); }
        function toggleChatModule(){/* ... as before ... */ if(!chatModuleContainerEl||!collapseIconEl)return; logInfo('Toggling chat module collapse'); if(isFullFrame){logWarn('Cannot collapse in full frame mode'); return;} isChatModuleCollapsed=!isChatModuleCollapsed; chatModuleContainerEl.classList.toggle('collapsed',isChatModuleCollapsed); collapseIconEl.innerHTML=isChatModuleCollapsed?'💬':'✖️'; collapseIconEl.title=isChatModuleCollapsed?'Open':'Close'; }
        function toggleFullFrame(){/* ... as before ... */ if(!chatModuleWrapper||!fullFrameToggleIconEl)return; logInfo('Toggling full frame mode'); isFullFrame=!isFullFrame; chatModuleWrapper.classList.toggle('full-frame-mode',isFullFrame); fullFrameToggleIconEl.innerHTML=isFullFrame?'↙️':'↗️'; fullFrameToggleIconEl.title=isFullFrame?'Exit Full':'Enter Full'; localStorage.setItem(LOCAL_STORAGE_KEYS.IS_FULL_FRAME,isFullFrame); if(isFullFrame&&isChatModuleCollapsed)chatModuleContainerEl.classList.remove('collapsed'); if(collapseIconEl)collapseIconEl.style.display=isFullFrame?'none':'inline-flex'; }
        function toggleSetupSection(){/* ... as before ... */ if(!setupSectionEl||!setupSectionTitleEl)return; logInfo('Toggling setup section'); setupSectionEl.classList.toggle('collapsed'); isSetupSectionCollapsed=setupSectionEl.classList.contains('collapsed'); localStorage.setItem(LOCAL_STORAGE_KEYS.IS_SETUP_COLLAPSED,isSetupSectionCollapsed); const arrow=setupSectionTitleEl.querySelector('span'); if(arrow)arrow.innerHTML=isSetupSectionCollapsed?'▶️':'🔽'; }
        function showClearModal(){logInfo('Showing clear modal'); if(clearStorageModalEl)clearStorageModalEl.style.display='flex';}
        function hideClearModal(){logInfo('Hiding clear modal'); if(clearStorageModalEl)clearStorageModalEl.style.display='none';}
        function confirmClear(){logWarn('Clearing local storage and reloading!'); Object.values(LOCAL_STORAGE_KEYS).forEach(k=>localStorage.removeItem(k)); hideClearModal(); addSystemMessage('Data cleared. Reloading...'); setTimeout(()=>window.location.reload(),1500);}
        function setLocalDisplayName(nameIn){const n=nameIn.trim(); const oldN=myDisplayName; if(n&&n.length>0&&n.length<=DISPLAY_NAME_MAX_LENGTH){logInfo('Setting display name locally:', n); myDisplayName=n; localStorage.setItem(LOCAL_STORAGE_KEYS.DISPLAY_NAME,myDisplayName); addSystemMessage(`Name set to "${sanitizeHTML(myDisplayName)}"`); if(setDisplayNameBtnEl)setDisplayNameBtnEl.textContent="Update"; updateChatLogDisplayName(myPeerId,myDisplayName); return true;}else if(!n){logInfo('Clearing display name'); myDisplayName=null; localStorage.removeItem(LOCAL_STORAGE_KEYS.DISPLAY_NAME); addSystemMessage(`Name cleared (was "${sanitizeHTML(oldN||'')}").`); if(displayNameInputEl)displayNameInputEl.value=""; if(setDisplayNameBtnEl)setDisplayNameBtnEl.textContent="Set Name"; updateChatLogDisplayName(myPeerId,null); return true;}else{addSystemMessage(`Invalid name (max ${DISPLAY_NAME_MAX_LENGTH}).`);return false;}}

        // --- PEERJS & CHAT ---
        function updateSelfStatusDisplay() {
            let statusText = "🚦 Ready. Set name, then Host/Connect.";
            if(peerIdDisplayAreaEl) peerIdDisplayAreaEl.style.display = 'none';
            if(copyMyIdBtnEl) copyMyIdBtnEl.disabled = true;
            if(sendBtnEl) sendBtnEl.disabled = true; // Default to disabled

            if (peer && peer.open && myPeerId) {
                const nameDisp = sanitizeHTML(myDisplayName || getShortPeerId(myPeerId));
                if(myPeerIdValueEl) myPeerIdValueEl.textContent = getShortPeerId(myPeerId);
                if(peerIdDisplayAreaEl) peerIdDisplayAreaEl.style.display = 'block';
                if(copyMyIdBtnEl) copyMyIdBtnEl.disabled = false;

                if (isHost) {
                    statusText = `Hosting as ${isActingAsServerOne ? '🌟ServerOne' : nameDisp}.`;
                    if(sendBtnEl) sendBtnEl.disabled = false; // Host can always send (even if no clients yet)
                } else if (hostConnection && hostConnection.open) {
                    const hostN = sanitizeHTML(hostConnection.displayName || `Host(${getShortPeerId(hostConnection.peer)})`);
                    const connTo = hostConnection.peer === SERVER_ONE_PEER_ID ? '🌟ServerOne' : hostN;
                    statusText = `✅ Connected to ${connTo} as ${nameDisp}.`;
                    if(sendBtnEl) sendBtnEl.disabled = false; // Client can send when connected
                } else {
                    statusText = `📶 Online as ${nameDisp}. Ready to connect/host.`;
                    // Send stays disabled if online but not connected/hosting
                }
            } else if (peerInitAttempts > 0 && peerInitAttempts <= MAX_PEER_INIT_ATTEMPTS) {
                 statusText = `⏳ Connecting PeerJS attempt ${peerInitAttempts}/${MAX_PEER_INIT_ATTEMPTS}...`;
            } else if (peerInitAttempts > MAX_PEER_INIT_ATTEMPTS) {
                if (peerJsServerErrorCount >= MAX_CONSECUTIVE_SERVER_ERRORS) statusText = `❌ Server connection failed. Try again.`;
                else statusText = `❌ PeerJS failed after ${MAX_PEER_INIT_ATTEMPTS} attempts. Try again.`;
            }
            updateStatusUI(statusText);
        }
        function addSystemMessage(text){logInfo('System Msg:', text); addMessage(text,'system',null);}
        function addChatMessage(text,senderId,senderName){addMessage(text,senderId,senderName);}
        function addMessage(text, senderId, senderNameFromNetwork) {
            if(!chatEl) { logError("chatEl not found in addMessage"); return; }
            const div = document.createElement('div'); div.className = 'message-item';
            const sanitizedText = sanitizeHTML(text);
            if(senderId && senderId !== 'system') { div.dataset.peerId = senderId; }
            if(senderId === 'system') { div.innerHTML = `<em>${sanitizedText}</em>`; div.classList.add('system-msg'); }
            else { let nameSpanHTML = ''; let finalDisplayLabel; let currentSenderNameToUse = senderNameFromNetwork;
                if(senderId === myPeerId) currentSenderNameToUse = myDisplayName;
                else if(isHost && connections[senderId]) currentSenderNameToUse = connections[senderId].displayName || senderNameFromNetwork;
                else if(!isHost && hostConnection && hostConnection.peer === senderId) currentSenderNameToUse = hostConnection.displayName || senderNameFromNetwork;
                const nameBase = sanitizeHTML(currentSenderNameToUse || getShortPeerId(senderId));
                if(senderId === myPeerId) { finalDisplayLabel = `${nameBase} (You)`; nameSpanHTML = `<span class="sender-tag you">${finalDisplayLabel}:</span> `; div.classList.add('local'); }
                else { let tagClass="peer"; finalDisplayLabel=nameBase; if(!isHost&&hostConnection&&hostConnection.peer===senderId){finalDisplayLabel=`Host(${nameBase})`;tagClass="host";} nameSpanHTML=`<span class="sender-tag ${tagClass}">${finalDisplayLabel}:</span> `; div.classList.add('remote'); }
                div.innerHTML = nameSpanHTML + sanitizedText;
            }
            const shouldScroll = chatEl.scrollTop + chatEl.clientHeight >= chatEl.scrollHeight - 30; // Check if near bottom before adding
            chatEl.appendChild(div);
            if (shouldScroll) chatEl.scrollTop = chatEl.scrollHeight; // Auto-scroll only if user was near the bottom
        }
        function updateChatLogDisplayName(peerIdToUpdate, newDisplayName) {
            if(!chatEl || !peerIdToUpdate) return;
            const messages = chatEl.querySelectorAll(`.message-item[data-peer-id="${peerIdToUpdate}"]`);
            logInfo(`Updating display name in chat log for ${getShortPeerId(peerIdToUpdate)} to "${newDisplayName || '(use ID)'}" (${messages.length} messages)`);
            messages.forEach(msgEl => {
                const tag = msgEl.querySelector('.sender-tag'); if(!tag) return;
                let label; const isLocal = peerIdToUpdate === myPeerId; const isHostMsg = !isHost && hostConnection && hostConnection.peer === peerIdToUpdate;
                const nameBase = sanitizeHTML(newDisplayName || getShortPeerId(peerIdToUpdate));
                if(isLocal) label = `${nameBase} (You)`; else if(isHostMsg) label = `Host(${nameBase})`; else label = nameBase;
                tag.innerHTML = `${label}:`;
            });
        }

        // --- PEERJS CORE ---
        function initializePeer(reqId=null, isS1Attempt=false) {
            if(peer && !peer.destroyed){ logWarn("Destroying existing peer before init."); peer.destroy(); }
            peer = null; peerInitAttempts++;
            logInfo(`Init PJS Attempt ${peerInitAttempts}. Host:${isHost}, S1:${isS1Attempt}, ReqID:${reqId||'auto'}`);

            if(peerInitAttempts > MAX_PEER_INIT_ATTEMPTS) { logError(`Max init attempts (${MAX_PEER_INIT_ATTEMPTS}) reached.`); updateStatusUI("❌ Max PeerJS tries. Try again manually."); if(hostBtnEl)hostBtnEl.disabled=false; if(connectBtnEl)connectBtnEl.disabled=false; updateSelfStatusDisplay(); return; }

            let idToTry;
            if(isHost) idToTry = isS1Attempt ? SERVER_ONE_PEER_ID : (reqId || DEFAULT_PEER_ID_PREFIX + Math.random().toString(36).substr(2, 9));
            else { idToTry = localStorage.getItem(LOCAL_STORAGE_KEYS.PEER_ID) || DEFAULT_PEER_ID_PREFIX + Math.random().toString(36).substr(2, 9); if(idToTry === SERVER_ONE_PEER_ID && !currentConnectionTargetIsServerOne) idToTry = DEFAULT_PEER_ID_PREFIX + Math.random().toString(36).substr(2, 9); }
            logInfo(`Attempting PJS connection with ID: ${idToTry}`);
            updateStatusUI(`⏳ Connecting PeerJS (Attempt ${peerInitAttempts})...`);

            try { peer = new Peer(idToTry, { config:{ iceServers:[{ urls:'stun:stun.l.google.com:19302' }] }, debug: 2 }); }
            catch(e) { logError(`Peer INSTANTIATION error: ${e}`, e); peerJsServerErrorCount++; updateStatusUI("❌ Error creating Peer object."); schedulePeerReinit(true, isHost && isS1Attempt); return; }

            peer.on('open', id => { logInfo(`✅ PeerJS OPEN. ID: ${id}`); myPeerId = id; peerInitAttempts = 0; peerJsServerErrorCount = 0; if(id !== SERVER_ONE_PEER_ID) localStorage.setItem(LOCAL_STORAGE_KEYS.PEER_ID, id); if(isHost) { isActingAsServerOne = (id === SERVER_ONE_PEER_ID && isS1Attempt); addSystemMessage(`Hosting ${isActingAsServerOne ? 'as 🌟ServerOne' : ''}. ID: ${getShortPeerId(id)}`); if(hostBtnEl)hostBtnEl.disabled = true; if(connectBtnEl)connectBtnEl.disabled = true; } else { if(hostBtnEl)hostBtnEl.disabled = false; if(connectBtnEl)connectBtnEl.disabled = false; } updateSelfStatusDisplay(); processMessageQueue(); });
            peer.on('connection', setupConnObj);
            peer.on('error', err => { logError(`💥 Peer Error: ${err.type}. Attempt ID: ${idToTry}. Host:${isHost}. S1:${isS1Attempt}. Msg: ${err.message || '(none)'}`, err); let schedRe = false; let forceN = false; let reS1 = isHost && isS1Attempt; let statMsg = `❌ Error: ${err.type}.`; const servErrs = ['network', 'server-error', 'socket-error', 'socket-closed', 'disconnected']; if (servErrs.includes(err.type)) { peerJsServerErrorCount++; logWarn(`Consecutive server errors: ${peerJsServerErrorCount}/${MAX_CONSECUTIVE_SERVER_ERRORS}`); if (peerJsServerErrorCount < MAX_CONSECUTIVE_SERVER_ERRORS) { schedRe = true; statMsg += " Retrying signal server..."; } else { statMsg = `❌ Persistent Server Conn issue (${err.type}). Check network. Try again manually.`; peerInitAttempts = MAX_PEER_INIT_ATTEMPTS + 1; if(hostBtnEl)hostBtnEl.disabled = false; if(connectBtnEl)connectBtnEl.disabled = false; } } else if (err.type === 'unavailable-id') { peerJsServerErrorCount = 0; statMsg = `❌ ID ${getShortPeerId(idToTry)} unavailable.`; if (isHost && isS1Attempt && idToTry === SERVER_ONE_PEER_ID) { addSystemMessage("🌟ServerOne taken. Hosting random ID."); if(peer&&!peer.destroyed)peer.destroy();peer=null; initializePeer(null, false); return; } else { forceN = true; schedRe = true; reS1 = false; statMsg += " Trying different ID..."; } } else if (err.type === 'peer-unavailable') { peerJsServerErrorCount = 0; const tgt = err.message ? err.message.split(' ').pop() : 'peer'; statMsg = `❌ Could not connect ${currentConnectionTargetIsServerOne ? 'to 🌟ServerOne' : 'to '+getShortPeerId(tgt)}. Offline/unreachable.`; addSystemMessage(statMsg); if(connectBtnEl)connectBtnEl.disabled = false; if(hostBtnEl && !isHost)hostBtnEl.disabled = false; } else { peerJsServerErrorCount = 0; statMsg = `❌ PeerJS Error (${err.type}). Try again manually.`; if(hostBtnEl)hostBtnEl.disabled = false; if(connectBtnEl)connectBtnEl.disabled = false; } updateStatusUI(statMsg); if(schedRe) schedulePeerReinit(forceN, reS1); updateSelfStatusDisplay(); });
            peer.on('disconnected', () => { logWarn('[P2P] Disconnected from PeerJS Server.'); updateStatusUI("⏳ Disconnected. Reconnecting..."); peerJsServerErrorCount++; if (peerJsServerErrorCount < MAX_CONSECUTIVE_SERVER_ERRORS) { schedulePeerReinit(false, isHost && isActingAsServerOne); } else { updateStatusUI("❌ Persistent disconnect. Check network. Try again."); peerInitAttempts = MAX_PEER_INIT_ATTEMPTS + 1; if(hostBtnEl)hostBtnEl.disabled = false; if(connectBtnEl)connectBtnEl.disabled = false; updateSelfStatusDisplay(); } });
            peer.on('close', () => { logWarn('[P2P] Peer closed.'); updateStatusUI("🚦 Connection closed. Host/Connect again."); myPeerId=null; peer=null; isActingAsServerOne=false; peerInitAttempts=0; peerJsServerErrorCount=0; if(hostBtnEl)hostBtnEl.disabled=false; if(connectBtnEl)connectBtnEl.disabled=false; updateSelfStatusDisplay(); });
        }
        function schedulePeerReinit(forceN, reS1){ if(peer&&!peer.destroyed)peer.destroy();peer=null; if(peerInitAttempts>MAX_PEER_INIT_ATTEMPTS||peerJsServerErrorCount>=MAX_CONSECUTIVE_SERVER_ERRORS){logWarn("Skipping scheduled re-init: Max attempts/errors."); updateStatusUI("❌ Failed PeerJS init. Try again."); if(hostBtnEl)hostBtnEl.disabled=false; if(connectBtnEl)connectBtnEl.disabled=false; updateSelfStatusDisplay(); return;} const d=Math.min(4000+(peerInitAttempts*2000),20000); logInfo(`Scheduling re-init in ${d/1000}s. ForceN:${forceN},ReS1:${reS1},Atmpt:${peerInitAttempts+1},SrvErrs:${peerJsServerErrorCount}`); updateStatusUI(`⏳ Connection failed. Retrying in ${Math.round(d/1000)}s...`); setTimeout(()=>{if(!peer){initializePeer(reS1&&isHost?SERVER_ONE_PEER_ID:null,reS1&&isHost);}else{logInfo("Skipping scheduled re-init, peer exists.");}},d);}
        function sendEncoded(c,dObj){if(c&&c.open){try{c.send(textEncoder.encode(JSON.stringify(dObj)));logInfo('Sent Encoded:', dObj, 'to', getShortPeerId(c.peer));}catch(e){logError('SendEnc Err:',e);}}else{logWarn('SendEnc on closed conn:', c?c.peer:'N/A');}}
        function setupConnObj(c){const cId=c.peer;c.displayName=c.metadata?.name||null;if(isHost){connections[cId]=c;logInfo(`Client Conn: ${getShortPeerId(cId)}(${c.displayName})`);}else{hostConnection=c;logInfo(`Host Conn: ${getShortPeerId(cId)}(${c.displayName})`);}c.on('open',()=>{const rName=sanitizeHTML(c.displayName||getShortPeerId(cId));addSystemMessage(`${rName} connected.`);currentConnectionTargetIsServerOne=false;if(!isHost){if(connectBtnEl)connectBtnEl.disabled=true;if(hostBtnEl)hostBtnEl.disabled=true;}updateSelfStatusDisplay();if(isHost)sendEncoded(c,{type:'host-announce',hId:myPeerId,hName:myDisplayName||getShortPeerId(myPeerId),isS1:isActingAsServerOne});processMessageQueue();});c.on('data',data=>{try{const d=JSON.parse(textDecoder.decode(data));logInfo('Received Data:',d,'from',getShortPeerId(cId));handleIncomingData(d,cId,c);}catch(e){logError('DataErr:',e,'Raw:',data);}});c.on('close',()=>{const rName=sanitizeHTML(c.displayName||getShortPeerId(cId));addSystemMessage(`${rName} disconnected.`);logWarn(`Conn closed: ${getShortPeerId(cId)}`);if(isHost){delete connections[cId];}else if(hostConnection&&hostConnection.peer===cId){hostConnection=null;if(hostIdInputEl)hostIdInputEl.value='';if(connectBtnEl)connectBtnEl.disabled=false;if(hostBtnEl&&!isHost)hostBtnEl.disabled=false;}updateSelfStatusDisplay();});c.on('error',err=>{logError(`ConnErr ${getShortPeerId(cId)}:${err.type}`);updateSelfStatusDisplay();});}
        function handleIncomingData(dObj,frm,cInst){logInfo('Handling Data:', dObj, 'from', getShortPeerId(frm)); const sndr=dObj.sName||(cInst?cInst.displayName:null)||getShortPeerId(frm);switch(dObj.type){case 'chat-message':addChatMessage(dObj.text,frm,dObj.sName);if(isHost)Object.values(connections).forEach(cOnn=>{if(cOnn.peer!==frm&&cOnn.open)sendEncoded(cOnn,dObj);});break;case 'name-update':const oN=sanitizeHTML((isHost?connections[frm]?.displayName:hostConnection?.displayName)||getShortPeerId(frm));if(isHost){if(connections[frm])connections[frm].displayName=dObj.newName;Object.values(connections).forEach(cOnn=>{if(cOnn.peer!==frm&&cOnn.open)sendEncoded(cOnn,dObj);});}else if(hostConnection&&hostConnection.peer===frm)hostConnection.displayName=dObj.newName;updateChatLogDisplayName(frm,dObj.newName);addSystemMessage(`${oN} is now ${sanitizeHTML(dObj.newName||getShortPeerId(frm))}.`);break;case 'host-announce':if(!isHost){if(cInst)cInst.displayName=dObj.hName;addSystemMessage(`Connected to host: ${sanitizeHTML(dObj.hName||getShortPeerId(frm))}${dObj.isS1?' (🌟ServerOne)':'_R'}.`);}break;}updateSelfStatusDisplay();}
        function processMessageQueue(){/* ... as before ... */ if(!peer||peer.destroyed||!peer.open){if(messageQueue.length>0)logInfo(`Peer not ready, ${messageQueue.length} msgs queued.`);return;}const tQ=[...messageQueue];messageQueue=[];tQ.forEach(i=>{let snt=false;if(i.target==='host'&&hostConnection&&hostConnection.open){sendToHost(i.text,true);snt=true;}else if(i.target==='broadcast'&&isHost){broadcastMessage(i.text,true);snt=true;}if(!snt)messageQueue.push(i);});}
        function broadcastMessage(txt,fQ=false){logInfo('Broadcasting msg:',txt); if(!isHost||!peer||!peer.open){if(!fQ)messageQueue.push({text:txt,target:'broadcast'});logWarn('Host/peer not ready, queue broadcast'); return;} addChatMessage(txt,myPeerId,myDisplayName||getShortPeerId(myPeerId)); const msgD={type:'chat-message',text:txt,sName:myDisplayName||getShortPeerId(myPeerId),peerId:myPeerId}; Object.values(connections).forEach(c=>sendEncoded(c,msgD));}
        function sendToHost(txt,fQ=false){logInfo('Sending msg to host:',txt); if(isHost||!hostConnection||!hostConnection.open){if(!fQ)messageQueue.push({text:txt,target:'host'});logWarn('Host conn not ready, queue send'); return;} addChatMessage(txt,myPeerId,myDisplayName||getShortPeerId(myPeerId)); sendEncoded(hostConnection,{type:'chat-message',text:txt,sName:myDisplayName||getShortPeerId(myPeerId),peerId:myPeerId});}
        function propagateDisplayNameChange(){if(peer&&peer.open&&myPeerId){logInfo('Propagating name change:',myDisplayName); const nUpdMsg={type:'name-update',peerId:myPeerId,newName:myDisplayName}; if(isHost){Object.values(connections).forEach(c=>{if(c.open)sendEncoded(c,nUpdMsg);});}else if(hostConnection&&hostConnection.open){sendEncoded(hostConnection,nUpdMsg);}}else{logWarn('Cannot propagate name, peer not ready.');}}

        // --- EVENT LISTENERS ---
        function attachEventListeners(){
            logInfo("Attaching event listeners...");
            // Helper to safely attach listener
            const safeAttach = (el, event, handler, options = false) => {
                if (el) { el.addEventListener(event, handler, options); }
                else { logError(`Cannot attach ${event} listener: Element not found.`); }
            };

            safeAttach(themeToggleIconEl, 'click', () => applyTheme(currentTheme==='dark'?'light':'dark'));
            safeAttach(collapseIconEl, 'click', toggleChatModule);
            safeAttach(fullFrameToggleIconEl, 'click', toggleFullFrame);
            safeAttach(clearStorageIconEl, 'click', showClearModal);
            safeAttach(confirmClearBtnEl, 'click', confirmClear);
            safeAttach(cancelClearBtnEl, 'click', hideClearModal);
            if(clearStorageModalEl) safeAttach(window, 'click', e => { if(e.target===clearStorageModalEl)hideClearModal(); });
            if(setupSectionTitleEl) safeAttach(setupSectionTitleEl, 'click', toggleSetupSection);

            safeAttach(setDisplayNameBtnEl, 'click', () => { logInfo('Set Name Btn Click'); if (displayNameInputEl && setLocalDisplayName(displayNameInputEl.value)) { propagateDisplayNameChange(); } updateSelfStatusDisplay(); });
            safeAttach(hostBtnEl, 'click', () => { logInfo('Host Btn Click'); isHost=true; isActingAsServerOne=false; currentConnectionTargetIsServerOne=false; if(hostBtnEl)hostBtnEl.disabled=true; if(connectBtnEl)connectBtnEl.disabled=true; if(peerIdDisplayAreaEl)peerIdDisplayAreaEl.style.display='none'; if(peer&&!peer.destroyed)peer.destroy(); peer=null; peerInitAttempts=0; initializePeer(SERVER_ONE_PEER_ID,true); });
            safeAttach(connectBtnEl, 'click', () => { logInfo('Connect Btn Click'); isHost=false; isActingAsServerOne=false; if(hostBtnEl)hostBtnEl.disabled=true; if(connectBtnEl)connectBtnEl.disabled=true; if(peerIdDisplayAreaEl)peerIdDisplayAreaEl.style.display='none'; let rId=hostIdInputEl.value.trim(); currentConnectionTargetIsServerOne=!rId; if(currentConnectionTargetIsServerOne)rId=SERVER_ONE_PEER_ID; addSystemMessage(`Connecting to ${getShortPeerId(rId)}...`); if(myPeerId&&rId===myPeerId){addSystemMessage("Cannot connect to self.");if(connectBtnEl)connectBtnEl.disabled=false;if(hostBtnEl&&!isHost)hostBtnEl.disabled=false;return;} const opts={reliable:true,serialization:'binary',metadata:{name:myDisplayName||getShortPeerId(myPeerId)}}; if(!peer||peer.destroyed||!peer.open){logInfo('Local peer not ready, initializing first...'); initializePeer(null,false); if(peer)peer.once('open',()=>{if(peer && !peer.destroyed){logInfo('Local peer opened, now connecting...'); hostConnection=peer.connect(rId,opts); setupConnObj(hostConnection);} else { logError('Local peer failed to open before connect attempt.'); addSystemMessage('Local connection init failed.'); if(connectBtnEl)connectBtnEl.disabled=false;if(hostBtnEl)hostBtnEl.disabled=false;}}); else {logError('Peer object null after initializePeer call in connect handler.'); addSystemMessage('Local connection init error.'); if(connectBtnEl)connectBtnEl.disabled=false;if(hostBtnEl)hostBtnEl.disabled=false;}} else {logInfo('Local peer ready, connecting...'); hostConnection=peer.connect(rId,opts); setupConnObj(hostConnection);} });

            const sendMessageHandler = () => {
                logInfo("Send Handler Triggered");
                if (!messageInputEl) { logError("messageInputEl is null in sendMessageHandler"); return; }
                const txt = messageInputEl.value.trim();
                if (!txt) { logInfo("No text to send."); return; }
                logInfo(`Attempting Send: text='${txt}', isHost=${isHost}, peer=${peer?.id}, open=${peer?.open}, hostConn=${hostConnection?.peer}, hcOpen=${hostConnection?.open}, conns=${Object.keys(connections).length}`);

                if (!peer || !peer.open || peer.destroyed) {
                    messageQueue.push({ text: txt, target: isHost ? 'broadcast' : 'host' });
                    addSystemMessage("Connection not ready. Queued.");
                    logWarn("Message queued: Peer not ready.", messageQueue);
                } else if (isHost) {
                    broadcastMessage(txt);
                } else if (hostConnection && hostConnection.open) {
                    sendToHost(txt);
                } else {
                    messageQueue.push({ text: txt, target: 'host' });
                    addSystemMessage("Not connected. Queued.");
                    logWarn("Message queued: No host connection.", messageQueue);
                }
                messageInputEl.value = ''; messageInputEl.focus();
            };

            safeAttach(sendBtnEl, 'click', sendMessageHandler);
            safeAttach(messageInputEl, 'keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessageHandler(); } });
            safeAttach(copyMyIdBtnEl, 'click', () => { if(!myPeerId)return; navigator.clipboard.writeText(myPeerId).then(()=>{addSystemMessage('Full ID copied!');copyMyIdBtnEl.textContent='Copied!';setTimeout(()=>copyMyIdBtnEl.textContent='Copy',2000);}).catch(e=>{addSystemMessage('Copy failed.');logError('Clipboard copy failed:',e)}); });
            logInfo("Event listeners attached.");
        }

        // --- INITIALIZATION ---
        function main(){
            logInfo("--- App Init Start ---");
            // Check essential elements needed for main logic itself
            if (!displayNameInputEl || !setDisplayNameBtnEl || !hostIdInputEl || !collapseIconEl || !themeToggleIconEl || !fullFrameToggleIconEl || !setupSectionEl || !setupSectionTitleEl || !hostBtnEl || !connectBtnEl) {
                 logError("CRITICAL UI elements missing in main(). Aborting.");
                 if(statusEl) statusEl.innerHTML = "❌ Fatal Error: UI elements missing. Cannot initialize.";
                 // Consider disabling everything visually
                 document.querySelectorAll('button, input').forEach(el => el.disabled = true);
                 return; // Stop initialization
            }

            myDisplayName=localStorage.getItem(LOCAL_STORAGE_KEYS.DISPLAY_NAME); displayNameInputEl.value=myDisplayName||""; setDisplayNameBtnEl.textContent=myDisplayName?"Update":"Set";
            currentTheme=localStorage.getItem(LOCAL_STORAGE_KEYS.THEME)||'dark'; applyTheme(currentTheme);
            collapseIconEl.innerHTML=isChatModuleCollapsed?'💬':'✖️'; if(isChatModuleCollapsed&&chatModuleContainerEl)chatModuleContainerEl.classList.add('collapsed');
            fullFrameToggleIconEl.innerHTML=isFullFrame?'↙️':'↗️'; if(isFullFrame&&chatModuleWrapper){chatModuleWrapper.classList.add('full-frame-mode');if(collapseIconEl)collapseIconEl.style.display='none';}
            if(localStorage.getItem(LOCAL_STORAGE_KEYS.IS_SETUP_COLLAPSED)==='true'){setupSectionEl.classList.add('collapsed');isSetupSectionCollapsed=true;} const ar=setupSectionTitleEl.querySelector('span');if(ar)ar.innerHTML=isSetupSectionCollapsed?'▶️':'🔽';
            hostIdInputEl.placeholder=`Peer ID (leave blank for 🌟ServerOne)`;
            updateSelfStatusDisplay(); addSystemMessage(`👋 Welcome! Set name, then Host or Connect.`); hostBtnEl.disabled=false; connectBtnEl.disabled=false;
            logInfo("--- App Init Complete ---");
        }

        // --- START ---
        if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', () => { main(); attachEventListeners(); });}
        else { main(); attachEventListeners(); }
    </script>
</body>
</html>
